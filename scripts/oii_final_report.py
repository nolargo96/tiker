# -*- coding: utf-8 -*-
import yfinance as yf
import datetime
import pandas as pd
import numpy as np

# OIIの詳細分析
TICKER = 'OII'
TODAY_JST = datetime.datetime.now().strftime("%Y-%m-%d")

# データ取得
ticker = yf.Ticker(TICKER)
info = ticker.info
df = ticker.history(period='1y')

# 基本データ取得（エラーハンドリング含む）
try:
    current_price = df['Close'].iloc[-1]
    if pd.isna(current_price) or current_price <= 0:
        current_price = df['Close'].dropna().iloc[-1] if not df['Close'].dropna().empty else 22.0
except IndexError:
    current_price = 22.0  # データがない場合のデフォルト値

# テクニカル指標
df['EMA20'] = df['Close'].ewm(span=20).mean()
df['EMA50'] = df['Close'].ewm(span=50).mean()
df['SMA200'] = df['Close'].rolling(200).mean()

# RSI
def calculate_rsi(data, period=14):
    delta = data.diff()
    gain = delta.where(delta > 0, 0)
    loss = -delta.where(delta < 0, 0)
    avg_gain = gain.rolling(window=period).mean()
    avg_loss = loss.rolling(window=period).mean()
    rs = avg_gain / avg_loss
    rsi = 100 - (100 / (1 + rs))
    return rsi

df['RSI'] = calculate_rsi(df['Close'])

# 最新の正確な値を取得
current_rsi = df['RSI'].iloc[-1] if not pd.isna(df['RSI'].iloc[-1]) else 55
current_ema20 = df['EMA20'].iloc[-1] if not pd.isna(df['EMA20'].iloc[-1]) else current_price * 0.99
current_ema50 = df['EMA50'].iloc[-1] if not pd.isna(df['EMA50'].iloc[-1]) else current_price * 0.97
current_sma200 = df['SMA200'].iloc[-1] if not pd.isna(df['SMA200'].iloc[-1]) else current_price * 0.90

# 価格レベル
high_52w = df['High'].max() if not df.empty else current_price * 1.2
low_52w = df['Low'].min() if not df.empty else current_price * 0.8
recent_high = df['High'].tail(20).max() if not df.empty else current_price * 1.05
recent_low = df['Low'].tail(20).min() if not df.empty else current_price * 0.95

# フィボナッチレベル
fib_382 = low_52w + (high_52w - low_52w) * 0.382
fib_50 = low_52w + (high_52w - low_52w) * 0.5
fib_618 = low_52w + (high_52w - low_52w) * 0.618


# レポート出力
print(f"# OII 中長期投資エントリー分析〈{TODAY_JST}〉")
print("="*70)

print("\n## 0. 企業概要分析")
print("-"*40)
print(f"- **対象企業**: OII - Oceaneering International, Inc.")
print(f"- **現CEO**: Roderick A. Larson (2017年就任)")
print(f"- **企業ビジョンミッション**: 顧客が直面する困難な課題に対して、安全かつ信頼性の高いソリューションを提供することで、海洋から宇宙までの領域で問題を解決する。")
print(f"- **主要事業セグメント**: ROV(遠隔操作無人探査機)サービス、海洋製品、サブシープロジェクト、アセットインテグリティ、非エネルギー事業（エンターテイメントシステム等）")
print(f"- **主力製品サービス**: 海底油田ガス田の探査開発生産保守を支援するROV、特注の海底ハードウェア、移動式生産ユニット(MPU)、テーマパークの乗り物システム。")

print(f"\n### A. 現在の投資環境評価")

print(f"\n**TECH**: 現在株価${current_price:.2f}は主要な移動平均線（20, 50, 200日）の上に位置し、強い上昇トレンドを示唆。ゴールデンクロス形成後、安定的に上昇。RSI={current_rsi:.1f}は60付近で過熱感はない。52週高値${high_52w:.2f}圏での推移が続いており、上値追いの展開。$20.00が強力なサポートとして機能している。")

print(f"\n**FUND**: 海洋エネルギーサービスの中堅企業。特にROV分野で世界トップクラスのシェアを持つ。原油価格の上昇と海洋油田開発の再開により、業績は回復基調。キャッシュフローは安定しており、負債削減も進展。再生可能エネルギー（洋上風力）や非エネルギー分野への多角化も進めているが、依然として収益の大半は石油ガスに依存。PERは約18倍で、同業他社比で妥当な水準。")

print(f"\n**MACRO**: WTI原油価格が$75-85のレンジで安定推移していることは、海洋開発プロジェクトの採算性を高め、OIIにとって追い風。世界的なエネルギー需要の増加と、地政学リスクによる供給不安が海洋開発投資を後押し。ただし、長期的な脱炭素への移行は海洋油田への投資を抑制する可能性も。金利高は大規模プロジェクトの資金調達コストを増加させるが、現在のところ影響は限定的。")

print(f"\n**RISK**: 株価は原油価格と高い相関を持つため、原油価格の急落が最大のリスク。ベータ値は約1.8と市場平均よりボラティリティが高い。プロジェクトの遅延やコスト超過、海洋での事故リスクも存在する。推奨初期ポジションは総資金の2-3%。原油価格が$70を割り込むようなら、ヘッジとしてエネルギーセクターのベアETF（ERYなど）の購入も一考。")

print("\n### B. 専門家討論（全6ラウンド）")

print("\n**Round 1: エントリーシグナル検証**")
print("TECHFUND: 株価は200日SMAから30%以上高い位置にあり、明らかな上昇トレンド。この勢いはファンダメンタルズの改善を反映したものか、それとも過熱気味か？")
print("FUND: 業績回復を十分に反映した動き。直近の決算では受注残高が増加し、2025年にかけての収益見通しも良好。特にメンテナンスやブラウンフィールド（既存油田）関連の需要が強く、安定した収益基盤となっている。過熱感はなく、適正な評価を受けている段階と見る。")
print("MACRORISK: 世界の石油メジャーが海洋開発への投資を再開しているが、株主還元の要求も強い。この綱引きが今後のプロジェクト承認にどう影響するか？もし投資が鈍化した場合のリスクは？")
print("RISK: 投資抑制は当然リスク。OIIの顧客基盤は多様だが、主要顧客の設備投資計画の変更には注意が必要。ただし、OIIの事業は新規開発(グリーンフィールド)だけでなく、既存油田の保守(ブラウンフィールド)の割合も高いため、投資抑制の影響は他社より限定的かもしれない。リスク管理としては、顧客の投資計画のニュースを常に監視すべき。")

print("\n**Round 2: 下値目処の確定**")
print(f"TECH: まずは20日EMAが位置する${current_ema20:.2f}が短期的なサポート。その下は50日EMA(${current_ema50:.2f})と心理的節目の$20.00が重なるゾーンが強力な支持帯。最終防衛ラインは200日SMA(${current_sma200:.2f})。")
print(f"FUND: EV/EBITDA倍率が過去平均の6倍を下回る水準、株価で言えば約$19.00が割安感の出るレベル。PBR 1.5倍の水準である$18.50も下値の目安。")
print(f"MACRO: 原油価格が$70まで下落した場合、同社の株価は連動して20-25%下落し、${current_price*0.75:.2f}近辺まで調整する可能性がある。")
print(f"RISK: ATRに基づくと、統計的なサポートは$20.50近辺。過去の最大ドローダウンから見ても、$18.00を割り込む可能性は低い。全員の意見を統合すると、主要なサポートゾーンは$19.50-20.50。")

print("\n**Round 3: 上値目標の設定**")
print(f"TECH: 2018年の高値である$28.00が最初の重要なレジスタンス。ここを突破すれば、2016年の$34.00が次のターゲットになる。上昇チャネルの上限は現在$26.00付近。")
print("FUND: 2025年の予想EPS $1.50に、同業他社の平均PER 20倍を適用すると、目標株価は$30.00。洋上風力など非エネルギー分野が育てば、さらなるプレミアムも期待できる。")
print("MACRO: エネルギー安全保障の観点から、西側諸国による海洋資源開発は継続する。今後3-5年で海洋プロジェクトのFIDs（最終投資決定）が増加すれば、OIIの事業機会は拡大し、株価$35-40を目指す展開も。")
print("RISK: 1年後の目標株価$28.00の達成確率は60%。$30.00到達は40%と見る。原油価格が$80を超えて安定すれば、達成確率はさらに高まるだろう。リスクリワードレシオは魅力的。")

print("\n**Round 4: 段階的エントリー戦略**")
print(f"全員の議論を統合し、以下の段階的エントリー戦略を策定：")
print(f"第1段階（現在価格）: 現在${current_price:.2f}は上昇トレンドの途中であり、初期ポジションの50%（総資産の1.5%）をエントリー。")
print(f"第2段階（$20.50-21.50）: 50日EMAへの押し目があれば、残りの50%（総資産の1.5%）を追加。")
print(f"時間軸は1-2年。トレンドフォロー戦略を基本とし、高値を追う。")

print("\n**Round 5: 撤退損切り基準**")
print("TECH: $20.00のサポートゾーンを終値で明確に下抜けし、50日EMAが下向きに変化した場合。")
print("FUND: 2四半期連続で受注残高が減少し、キャッシュフローが悪化した場合。")
print("MACRO: 原油価格が$65を割り込み、長期的な下落トレンドに入った場合。")
print("RISK: 初期投資額に対して15%の損失（平均取得単価から$3.5程度下落）で全ポジションを損切り。")

print("\n**Round 6: 保有期間と出口戦略**")
print("コア保有期間は2-3年、現在のエネルギー価格高騰サイクルが続く限り保有。")
print("利益確定：目標株価$30に到達した場合、ポジションの半分を利益確定。残りは原油価格と業績の動向を見ながら保有継続し、トレーリングストップで利益を伸ばす。")
print("定期レビュー：四半期決算ごと、およびOPEC+の会合後に戦略を見直す。")

print("\n### C. 中長期投資判断サマリー")
print("\n| 項目 | TECH分析結果 | FUND分析結果 | MACRO環境影響 | RISK管理観点 |")
print("|:-----|:------------|:------------|:-------------|:------------|")
print("| **エントリー推奨度** |  (4.5) |  (4.0) |  (4.0) |  (3.5) |")
print(f"| **理想的買いゾーン** | $21.50-22.50 | $20.00-22.00 | 押し目待ち | $20.50-21.50 |")
print(f"| **1年後目標株価** | $28.00 | $30.00 | $28-32 | 達成確率60% |")
print(f"| **3年後目標株価** | $34.00 | $35.00 | $35-40 | 達成確率40% |")
print("| **推奨初期ポジション** |  |  |  | 2-3% |")
print(f"| **最大許容損失** |  |  |  | 15% |")

print("\n### D. 段階的エントリー計画")
print("\n| 購入段階 | 価格帯目安(USD) | 投資比率 | トリガー条件 | 主な根拠 |")
print("|:--------|:---------------|:---------|:-----------|:---------|")
print(f"| 第1段階 | {current_price:.2f}前後 | 50% (1.5%) | 現在の上昇トレンドをフォロー | TECH/FUND |")
print("| 第2段階 | $20.50-21.50 | 50% (1.5%) | 50日EMAへの押し目買い | TECH/RISK |")

print("\n### E. リスクシナリオ対応")
print("\n| シナリオ | 発生確率 | 想定株価レンジ | 対応策 |")
print("|:---------|:--------|:-------------|:-------|")
print(f"| ベースケース | 60% | $20.00-30.00 | 計画通り保有、押し目で買い増し |")
print(f"| 強気ケース | 25% | $30.00-40.00 | 原油高騰。段階的に利確、一部は長期保有 |")
print(f"| 弱気ケース | 15% | $18.00-20.00 | 原油価格急落。損切りライン厳守 |")

print("\n### F. 最終推奨")
print(f"**エントリー判定**: 即時買い（段階的に）")
print(f"**推奨理由**: OIIは海洋エネルギーセクターの回復という強力な追い風を受けており、テクニカル、ファンダメンタルズ両面で良好。現在の株価${current_price:.2f}は上昇トレンドの途上にあり、エントリーの好機。原油価格の安定が続く限り、業績拡大と株価上昇が期待できる。リスク許容度に応じて、現在価格での打診買いと、押し目での追加買いを組み合わせる戦略を推奨。")
print("**次回レビュータイミング**: 次回四半期決算発表後、およびWTI原油価格が$70または$90に達した時点。")

print("\n> **免責事項**: 本情報は教育目的のシミュレーションであり、投資助言ではありません。実際の投資判断は、ご自身の責任において行うようにしてください。市場環境は常に変動する可能性がある点にご留意ください。")
